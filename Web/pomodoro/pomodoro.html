<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Pomodoro Timer por tarefa com relógio analógico - Life Sync.">
    <title>Pomodoro por Tarefa - Life Sync</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../style.css">
    <link rel="stylesheet" href="pomodoro.css">
</head>
<body>
    <header class="main-header">
        <div class="container">
            <h1 class="logo"><a href="../../index.html" style="color: white; text-decoration: none;">Life Sync</a></h1>
            <nav class="main-nav" aria-label="Navegação principal">
                <ul>
                    <li><a href="../../index.html">Home</a></li>
                    <li><a href="../lista/lista.html" id="listaLink">Lista de Tarefas</a></li>
                    <li><a href="../calendario/calendario.html" id="pomodoroLink">Calendário</a></li>
                    <li class="auth-links">
                        <a href="../login/login.html" id="loginLink" class="btn-outline">Login</a>
                        <a href="../cadastro/cadastro.html" id="cadastroLink" class="btn-primary">Cadastrar</a>
                        <button id="logoutLink" class="btn-text" style="display:none;">Logout</button>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="container section-padding">
        <section class="pomodoro-tasks-container">
            <div class="tasks-header-card">
                <h2 class="section-title">Pomodoro por Tarefa</h2>
                <p>Adicione suas metas e gerencie o tempo de foco para cada uma individualmente com timers digitais e analógicos.</p>
                <div class="task-input-group">
                    <input type="text" id="task" placeholder="Nova tarefa">
                    <button id="addTask" class="btn-primary">Adicionar Tarefa</button>
                </div>
            </div>

            <ul id="taskList" class="task-timer-list">
                <!-- Tarefas serão inseridas aqui -->
            </ul>
        </section>
    </main>

    <footer class="main-footer">
        <div class="container">
            <p>&copy; 2024 Life Sync. Foco e organização para o seu dia a dia.</p>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getDatabase, ref, onValue, push, set, remove, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyCh9Efra6D6DjRia4Yubq44NV28eeDPa8E",
            authDomain: "life-sync-fa0ee.firebaseapp.com",
            databaseURL: "https://life-sync-fa0ee-default-rtdb.firebaseio.com",
            projectId: "life-sync-fa0ee",
            storageBucket: "life-sync-fa0ee.appspot.com",
            messagingSenderId: "78086954632",
            appId: "1:78086954632:web:567a52d817e3de1280093d",
            measurementId: "G-EN04957NEZ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        document.addEventListener("DOMContentLoaded", () => {
            const taskInput = document.getElementById('task');
            const addTaskButton = document.getElementById('addTask');
            const taskList = document.getElementById('taskList');
            const logoutLink = document.getElementById("logoutLink");
            
            let currentUser = null;

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    document.getElementById("loginLink").style.display = "none";
                    document.getElementById("cadastroLink").style.display = "none";
                    logoutLink.style.display = "block";
                    loadTasks();
                } else {
                    currentUser = null;
                    document.getElementById("loginLink").style.display = "block";
                    document.getElementById("cadastroLink").style.display = "block";
                    logoutLink.style.display = "none";
                    taskList.innerHTML = '<li class="empty-msg">Faça login para gerenciar suas tarefas</li>';
                }
            });

            addTaskButton.addEventListener('click', () => {
                const task = taskInput.value.trim();
                if (task && currentUser) {
                    addTaskButton.disabled = true;
                    const tasksRef = ref(db, `usuarios/${currentUser.uid}/tarefas`);
                    push(tasksRef, {
                        nomeTarefa: task,
                        estadoAtual: 'ativo',
                        pomodoroConcluido: 0,
                        tempoCriacao: Date.now()
                    }).then(() => {
                        taskInput.value = '';
                        addTaskButton.disabled = false;
                    }).catch(() => addTaskButton.disabled = false);
                }
            });

            function loadTasks() {
                onValue(ref(db, `usuarios/${currentUser.uid}`), (snapshot) => {
                    const data = snapshot.val();
                    updateUI(data);
                });
            }

            function updateUI(data) {
                taskList.innerHTML = '';
                if (data && data.tarefas) {
                    Object.keys(data.tarefas).forEach(taskId => {
                        renderTask(data.tarefas[taskId].nomeTarefa, taskId, data.tarefas[taskId].estadoAtual);
                    });
                } else {
                    taskList.innerHTML = '<li class="empty-msg">Nenhuma tarefa encontrada</li>';
                }
            }

            function renderTask(taskName, taskId, estado) {
                const li = document.createElement('li');
                li.className = 'task-timer-item' + (estado === 'concluido' ? ' done' : '');
                li.setAttribute('data-task', taskId);

                // Relógio Analógico
                const analogClock = document.createElement('div');
                analogClock.className = 'analog-clock';
                const hourHand = document.createElement('div');
                hourHand.className = 'hand hour';
                const minuteHand = document.createElement('div');
                minuteHand.className = 'hand minute';
                analogClock.append(hourHand, minuteHand);

                const taskInfo = document.createElement('div');
                taskInfo.className = 'task-info';
                taskInfo.innerHTML = `<strong>${taskName}</strong>`;

                const pomodoroDiv = document.createElement('div');
                pomodoroDiv.className = 'pomodoro';

                const minutesDisplay = document.createElement('span');
                minutesDisplay.className = 'minutes';
                minutesDisplay.textContent = '25';
                const secondsDisplay = document.createElement('span');
                secondsDisplay.className = 'seconds';
                secondsDisplay.textContent = '00';

                const startBtn = document.createElement('button');
                startBtn.textContent = 'Iniciar';
                startBtn.className = 'startButton';

                const pauseBtn = document.createElement('button');
                pauseBtn.textContent = 'Pausar';
                pauseBtn.className = 'pauseButton';

                const resetBtn = document.createElement('button');
                resetBtn.textContent = 'Resetar';
                resetBtn.className = 'resetButton';

                const completeBtn = document.createElement('button');
                completeBtn.textContent = 'Finalizar';
                completeBtn.className = 'complete-btn';

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Limpar';
                deleteBtn.className = 'delete-btn';
                deleteBtn.style.display = estado === 'concluido' ? 'block' : 'none';

                pomodoroDiv.append(minutesDisplay, document.createTextNode(':'), secondsDisplay, startBtn, pauseBtn, resetBtn);
                li.append(analogClock, taskInfo, pomodoroDiv, completeBtn, deleteBtn);
                taskList.appendChild(li);

                // Lógica do Timer
                let minutes = 25;
                let seconds = 0;
                let interval;
                let isPaused = false;
                let cycle = 0;

                function updateDisplay() {
                    minutesDisplay.textContent = String(minutes).padStart(2, '0');
                    secondsDisplay.textContent = String(seconds).padStart(2, '0');
                    
                    // Atualiza Relógio Analógico (Simulação visual baseada no progresso do Pomodoro)
                    const totalSeconds = 25 * 60;
                    const currentSeconds = (minutes * 60) + seconds;
                    const progress = 1 - (currentSeconds / totalSeconds);
                    const rotation = progress * 360;
                    minuteHand.style.transform = `rotate(${rotation}deg)`;
                    hourHand.style.transform = `rotate(${rotation / 12}deg)`;
                }

                startBtn.onclick = () => {
                    if (interval) clearInterval(interval);
                    isPaused = false;
                    pauseBtn.textContent = 'Pausar';
                    interval = setInterval(() => {
                        if (!isPaused) {
                            if (seconds === 0) {
                                if (minutes === 0) {
                                    clearInterval(interval);
                                    interval = null;
                                    cycle++;
                                    minutes = (cycle % 4 === 0) ? 15 : 5;
                                    seconds = 0;
                                    startBtn.textContent = 'Novo Ciclo';
                                    alert(`Ciclo concluído: ${taskName}`);
                                    return;
                                }
                                minutes--;
                                seconds = 59;
                            } else {
                                seconds--;
                            }
                            updateDisplay();
                        }
                    }, 1000);
                };

                pauseBtn.onclick = () => {
                    isPaused = !isPaused;
                    pauseBtn.textContent = isPaused ? 'Retomar' : 'Pausar';
                };

                resetBtn.onclick = () => {
                    clearInterval(interval);
                    interval = null;
                    minutes = 25;
                    seconds = 0;
                    isPaused = false;
                    startBtn.textContent = 'Iniciar';
                    updateDisplay();
                };

                completeBtn.onclick = () => {
                    clearInterval(interval);
                    li.classList.toggle('done');
                    const novoEstado = li.classList.contains('done') ? 'concluido' : 'ativo';
                    update(ref(db, `usuarios/${currentUser.uid}/tarefas/${taskId}`), { estadoAtual: novoEstado });
                };

                deleteBtn.onclick = () => {
                    if(confirm('Remover tarefa?')) remove(ref(db, `usuarios/${currentUser.uid}/tarefas/${taskId}`));
                };
            }

            logoutLink.onclick = (e) => {
                e.preventDefault();
                signOut(auth).then(() => window.location.href = "../../index.html");
            };
        });
    </script>
</body>
</html>